<style>
    video { display: block; margin-top: 15px; }
    #videoContainer {
        width: 480px;
    }
    .slider { width: 100%; margin: 10px 0; }
</style>

<div class="genCenterRow">
  <div class="genRow">
    <h2>视频转GIF</h2>
  </div>

  <!--post form-->
  <div class="genRow">
    <form enctype="multipart/form-data" method="post">
    <input type="button" class="fileUploader" id="uploadFile" name="uploadFile" value="选择视频文件"/>
    <input type="file" name="upload" id="upload" accept="video/mp4,video/quicktime,video/x-m4v,video/*" style="display:none;" />

    <div id="videoContainer">
        <!-- origin video -->
        <video id="preview" width="480px" controls></video>

        <p id="duration">
            视频时长: 0 秒
        </p>
        <div>
            <label>开始时间: <span id="startTime">0</span>s</label><br>
            <input type="range" id="startSlider" class="slider" min="0" value="0" disabled>
        </div>
        <div>
            <label>结束时间: <span id="endTime">0</span>s</label><br>
            <input type="range" id="endSlider" class="slider" min="0" value="0" disabled>
        </div>
    </div>

    <button type="button" id="submitBtn">确认选择片段</button>
    </form>
  </div>
</div>

<script>
    let videoElement = $("#preview")[0];
    let duration = 0;
    let start = 0;
    let end = 0;
    let maxSeconds = 10; //xx seconds

    //ready
    $(function() {
      //disabled start and end slider
      $("#startSlider, #endSlider").prop("disabled", true);
      $("#submitBtn").prop("disabled", true);

      //upload file click opt
      $("#uploadFile").click(function() {
        //$("#uploadFile").val("视频文件");
        $("#upload").click();
        return
      });
    });

    // 上传并预览视频
    $("#upload").on("change", function(e) {
        let file = e.target.files[0];
        if (file) {
            let url = URL.createObjectURL(file);
            $("#preview").attr("src", url);

            videoElement.onloadedmetadata = function() {
                duration = videoElement.duration;
                $("#duration").text("视频时长: " + duration.toFixed(2) + " 秒");


                // 启用滑块
                $("#startSlider, #endSlider").prop("disabled", false);
                $("#submitBtn").prop("disabled", false);

                $("#startSlider, #endSlider").attr("max", Math.floor(duration));
                $("#startSlider").val(0);
                $("#endSlider").val(Math.floor(duration));
                $("#startTime").text(0);
                $("#endTime").text(Math.floor(duration));

                start = 0;
                end = Math.floor(duration);
            };
        }
    });

    // 开始滑块
    $("#startSlider").on("input", function() {
        start = parseInt($(this).val());

        // 自动计算结束时间
        if (start + maxSeconds <= duration) {
            end = start + maxSeconds;
        } else {
            end = duration; // 视频末尾
        }

        // 更新滑块显示
        $("#startTime").text(start);
        $("#endTime").text(end);
        $("#endSlider").val(end);

        // 视频跳到起点
        videoElement.currentTime = start;
    });

    // 结束滑块
    $("#endSlider").on("input", function() {
        end = parseInt($(this).val());
        // 如果结束 <= 开始，强制修正
        if (end - maxSeconds <= start) {
            start = end - maxSeconds >= maxSeconds ? end - maxSeconds : 0;
            $("#startSlider").val(start);
            $("#startTime").text(start);
        }

        // 如果超过最大时长，往前推 start
        if (end - start > maxSeconds) {
            start = end - maxSeconds;
            $("#startSlider").val(start);
            $("#startTime").text(start);
        }

        $("#endTime").text(end);
        videoElement.currentTime = start;
    });

    // 播放控制：只播放选定区间
    videoElement.addEventListener("timeupdate", function() {
        if (videoElement.currentTime < start) {
            videoElement.currentTime = start;
        }
        if (videoElement.currentTime >= end) {
            videoElement.pause();
            videoElement.currentTime = start; // 重置到开始时间
        }
    });

    // 点击提交
    $("#submitBtn").on("click", function(e) {
        //阻止表单提交刷新
        e.preventDefault();

        let length = end - start;
        if (length > maxSeconds) {
            floatTipMessage(`片段超过 `+maxSeconds+` 秒，将自动裁剪为 `
                +maxSeconds+` 秒以内`, "info");
            end = start + maxSeconds;
        }
        //alert("选择的片段: " + start + "s ~ " + end + "s (时长: " + (end - start) + "s)");

        //setup para
        var paraMap = {
            "fileId":"upload",
            "startTime":start,
            "submitBtn":"submitBtn",
        };

        //save uploaded video
        video2gifUploadVideo(paraMap);
    });
</script>
